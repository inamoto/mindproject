(function(p){var r=function(){},g="undefined"===typeof console?{log:r,debug:r,error:r,warn:r,info:r}:console;if("undefined"!=typeof p.jsMind)g.log("jsMind has been already exist.");else{var n=p.document,t=function(a,b){a.hasChildNodes()?a.firstChild.nodeValue=b:a.appendChild(n.createTextNode(b))},u=function(a){return!!a&&"object"===typeof a&&1===a.nodeType&&"object"===typeof a.style&&"object"===typeof a.ownerDocument};"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,
a.length)===a});var v={container:"",editable:!1,theme:null,mode:"full",support_html:!0,view:{hmargin:100,vmargin:50,line_width:2,line_color:"#555"},layout:{hspace:30,vspace:20,pspace:13},default_event_handle:{enable_mousedown_handle:!0,enable_click_handle:!0,enable_dblclick_handle:!0},shortcut:{enable:!0,handles:{},mapping:{addchild:45,addbrother:13,editnode:113,delnode:46,toggle:32,left:37,up:38,right:39,down:40}}},e=function(a){e.current=this;this.version="0.4.3";var b={};e.util.json.merge(b,v);
e.util.json.merge(b,a);b.container?(this.options=b,this.inited=!1,this.mind=null,this.event_handles=[],this.init()):g.error("the options.container should not be null or empty.")};e.direction={left:-1,center:0,right:1};e.event_type={show:1,resize:2,edit:3,select:4};e.node=function(a,b,c,d,f,e,q,k){a?"number"!=typeof b?g.error("invalid node index"):("undefined"===typeof k&&(k=!0),this.id=a,this.index=b,this.topic=c,this.data=d||{},this.isroot=f,this.parent=e,this.direction=q,this.expanded=!!k,this.children=
[],this._data={}):g.error("invalid nodeid")};e.node.compare=function(a,b){var c=a.index,d=b.index;return 0<=c&&0<=d?c-d:-1==c&&-1==d?0:-1==c?1:-1==d?-1:0};e.node.inherited=function(a,b){if(a&&b){if(a.id===b.id||a.isroot)return!0;for(var c=a.id,d=b;!d.isroot;)if(d=d.parent,d.id===c)return!0}return!1};e.node.prototype={get_location:function(){var a=this._data.view;return{x:a.abs_x,y:a.abs_y}},get_size:function(){var a=this._data.view;return{w:a.width,h:a.height}}};e.mind=function(){this.selected=this.root=
this.version=this.author=this.name=null;this.nodes={}};e.mind.prototype={get_node:function(a){if(a in this.nodes)return this.nodes[a];g.warn("the node[id="+a+"] can not be found");return null},set_root:function(a,b,c){null==this.root?(this.root=new e.node(a,0,b,c,!0),this._put_node(this.root)):g.error("root node is already exist")},add_node:function(a,b,c,d,f,h,q){if(!e.util.is_node(a)){var k=this.get_node(a);if(k)return this.add_node(k,b,c,d,f,h,q);g.error("the parent_node[id="+a+"] can not be found.");
return null}f=f||-1;if(a.isroot){if(isNaN(h)){h=a.children;k=h.length;for(var l=0,m=0;m<k;m++)h[m].direction===e.direction.left?l--:l++;h=1<k&&0<l?e.direction.left:e.direction.right}else h=h!=e.direction.left?e.direction.right:e.direction.left;b=new e.node(b,f,c,d,!1,a,h,q)}else b=new e.node(b,f,c,d,!1,a,a.direction,q);this._put_node(b)?(a.children.push(b),this._reindex(a)):(g.error("fail, the nodeid '"+b.id+"' has been already exist."),b=null);return b},insert_node_before:function(a,b,c,d){if(!e.util.is_node(a)){var f=
this.get_node(a);if(f)return this.insert_node_before(f,b,c,d);g.error("the node_before[id="+a+"] can not be found.");return null}return this.add_node(a.parent,b,c,d,a.index-.5)},get_node_before:function(a){if(!e.util.is_node(a)){var b=this.get_node(a);if(b)return this.get_node_before(b);g.error("the node[id="+a+"] can not be found.");return null}if(a.isroot)return null;b=a.index-2;return 0<=b?a.parent.children[b]:null},insert_node_after:function(a,b,c,d){if(!e.util.is_node(a)){var f=this.get_node(node_before);
if(f)return this.insert_node_after(f,b,c,d);g.error("the node_after[id="+a+"] can not be found.");return null}return this.add_node(a.parent,b,c,d,a.index+.5)},get_node_after:function(a){if(!e.util.is_node(a)){var b=this.get_node(a);if(b)return this.get_node_after(b);g.error("the node[id="+a+"] can not be found.");return null}if(a.isroot)return null;b=a.index;return a.parent.children.length>=b?a.parent.children[b]:null},move_node:function(a,b,c,d){if(!e.util.is_node(a)){var f=this.get_node(a);if(f)return this.move_node(f,
b,c,d);g.error("the node[id="+a+"] can not be found.");return null}c||(c=a.parent.id);return this._move_node(a,b,c,d)},_flow_node_direction:function(a,b){"undefined"===typeof b?b=a.direction:a.direction=b;for(var c=a.children.length;c--;)this._flow_node_direction(a.children[c],b)},_move_node_internal:function(a,b){if(a&&b)if("_last_"==b)a.index=-1,this._reindex(a.parent);else if("_first_"==b)a.index=0,this._reindex(a.parent);else{var c=b?this.get_node(b):null;null!=c&&null!=c.parent&&c.parent.id==
a.parent.id&&(a.index=c.index-.5,this._reindex(a.parent))}return a},_move_node:function(a,b,c,d){if(a&&c){if(a.parent.id!=c){for(var f=a.parent.children,h=f.length;h--;)if(f[h].id==a.id){f.splice(h,1);break}a.parent=this.get_node(c);a.parent.children.push(a)}a.direction=a.parent.isroot?d==jsMind.direction.left?d:e.direction.right:a.parent.direction;this._move_node_internal(a,b);this._flow_node_direction(a)}return a},remove_node:function(a){if(!e.util.is_node(a)){var b=this.get_node(a);if(b)return this.remove_node(b);
g.error("the node[id="+a+"] can not be found.");return!1}if(!a)return g.error("fail, the node can not be found"),!1;if(a.isroot)return g.error("fail, can not remove root node"),!1;null!=this.selected&&this.selected.id==a.id&&(this.selected=null);for(var c=a.children,d=c.length;d--;)this.remove_node(c[d]);c.length=0;c=a.parent.children;for(d=c.length;d--;)if(c[d].id==a.id){c.splice(d,1);break}delete this.nodes[a.id];for(b in a)delete a[b];return!0},_put_node:function(a){if(a.id in this.nodes)return g.warn("the nodeid '"+
a.id+"' has been already exist."),!1;this.nodes[a.id]=a;return!0},_reindex:function(a){if(a instanceof e.node){a.children.sort(e.node.compare);for(var b=0;b<a.children.length;b++)a.children[b].index=b+1}}};e.format={node_tree:{example:{meta:{name:"jsMind",author:"hizzgdev@163.com",version:"0.4.3"},format:"node_tree",data:{id:"root",topic:"jsMind Example"}},get_mind:function(a){var b=e.format.node_tree,c=new e.mind;c.name=a.meta.name;c.author=a.meta.author;c.version=a.meta.version;b._parse(c,a.data);
return c},get_data:function(a){var b=e.format.node_tree,c={};c.meta={name:a.name,author:a.author,version:a.version};c.format="node_tree";c.data=b._buildnode(a.root);return c},_parse:function(a,b){var c=e.format.node_tree,d=c._extract_data(b);a.set_root(b.id,b.topic,d);if("children"in b){d=b.children;for(var f=0;f<d.length;f++)c._extract_subnode(a,a.root,d[f])}},_extract_data:function(a){var b={},c;for(c in a)"id"!=c&&"topic"!=c&&"children"!=c&&"direction"!=c&&"expanded"!=c&&(b[c]=a[c]);return b},
_extract_subnode:function(a,b,c){var d=e.format.node_tree,f=d._extract_data(c),h=null;b.isroot&&(h="left"==c.direction?e.direction.left:e.direction.right);b=a.add_node(b,c.id,c.topic,f,null,h,c.expanded);if("children"in c)for(c=c.children,f=0;f<c.length;f++)d._extract_subnode(a,b,c[f])},_buildnode:function(a){var b=e.format.node_tree;if(a instanceof e.node){var c={id:a.id,topic:a.topic,expanded:a.expanded};a.parent&&a.parent.isroot&&(c.direction=a.direction==e.direction.left?"left":"right");if(null!=
a.data){var d=a.data,f;for(f in d)c[f]=d[f]}a=a.children;if(0<a.length)for(c.children=[],d=0;d<a.length;d++)c.children.push(b._buildnode(a[d]));return c}}},node_array:{example:{meta:{name:"jsMind",author:"hizzgdev@163.com",version:"0.4.3"},format:"node_array",data:[{id:"root",topic:"jsMind Example",isroot:!0}]},get_mind:function(a){var b=e.format.node_array,c=new e.mind;c.name=a.meta.name;c.author=a.meta.author;c.version=a.meta.version;b._parse(c,a.data);return c},get_data:function(a){var b=e.format.node_array,
c={};c.meta={name:a.name,author:a.author,version:a.version};c.format="node_array";c.data=[];b._array(a,c.data);return c},_parse:function(a,b){var c=e.format.node_array,d=b.slice(0);d.reverse();var f=c._extract_root(a,d);f?c._extract_subnode(a,f,d):g.error("root node can not be found")},_extract_root:function(a,b){for(var c=e.format.node_array,d=b.length;d--;)if("isroot"in b[d]&&b[d].isroot){var f=b[d];c=c._extract_data(f);a.set_root(f.id,f.topic,c);b.splice(d,1);return f.id}return null},_extract_subnode:function(a,
b,c){for(var d=e.format.node_array,f=c.length,h,g,k=0;f--;)if(h=c[f],h.parentid==b){g=d._extract_data(h);var l=null,m=h.direction;m&&(l="left"==m?e.direction.left:e.direction.right);a.add_node(b,h.id,h.topic,g,null,l,h.expanded);c.splice(f,1);k++;h=d._extract_subnode(a,h.id,c);0<h&&(f=c.length,k+=h)}return k},_extract_data:function(a){var b={},c;for(c in a)"id"!=c&&"topic"!=c&&"parentid"!=c&&"isroot"!=c&&"direction"!=c&&"expanded"!=c&&(b[c]=a[c]);return b},_array:function(a,b){e.format.node_array._array_node(a.root,
b)},_array_node:function(a,b){var c=e.format.node_array;if(a instanceof e.node){var d={id:a.id,topic:a.topic,expanded:a.expanded};a.parent&&(d.parentid=a.parent.id);a.isroot&&(d.isroot=!0);a.parent&&a.parent.isroot&&(d.direction=a.direction==e.direction.left?"left":"right");if(null!=a.data){var f=a.data,h;for(h in f)d[h]=f[h]}b.push(d);d=a.children.length;for(f=0;f<d;f++)c._array_node(a.children[f],b)}}},freemind:{example:{meta:{name:"jsMind",author:"hizzgdev@163.com",version:"0.4.3"},format:"freemind",
data:'<map version="1.0.1"><node ID="root" TEXT="freemind Example"/></map>'},get_mind:function(a){var b=e.format.freemind,c=new e.mind;c.name=a.meta.name;c.author=a.meta.author;c.version=a.meta.version;a=b._parse_xml(a.data);a=b._find_root(a);b._load_node(c,null,a);return c},get_data:function(a){var b=e.format.freemind,c={};c.meta={name:a.name,author:a.author,version:a.version};c.format="freemind";var d=[];d.push('<map version="1.0.1">');b._buildmap(a.root,d);d.push("</map>");c.data=d.join(" ");return c},
_parse_xml:function(a){if(window.DOMParser)var b=(new DOMParser).parseFromString(a,"text/xml");else b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a);return b},_find_root:function(a){var b=a.childNodes;a=null;for(var c,d=0;d<b.length;d++)if(c=b[d],1==c.nodeType&&"map"==c.tagName){a=c;break}if(a)for(b=a.childNodes,a=null,d=0;d<b.length;d++)if(c=b[d],1==c.nodeType&&"node"==c.tagName){a=c;break}return a},_load_node:function(a,b,c){var d=e.format.freemind,f=c.getAttribute("ID"),h=c.getAttribute("TEXT");
if(null==h)for(var g=c.childNodes,k,l=0;l<g.length;l++)if(k=g[l],1==k.nodeType&&"richcontent"===k.tagName){h=k.textContent;break}l=d._load_attributes(c);g="expanded"in l?"true"==l.expanded:!0;delete l.expanded;k=c.getAttribute("POSITION");var m=null;k&&(m="left"==k?e.direction.left:e.direction.right);b?a.add_node(b,f,h,l,null,m,g):a.set_root(f,h,l);b=c.childNodes;for(l=0;l<b.length;l++)c=b[l],1==c.nodeType&&"node"==c.tagName&&d._load_node(a,f,c)},_load_attributes:function(a){a=a.childNodes;for(var b,
c={},d=0;d<a.length;d++)b=a[d],1==b.nodeType&&"attribute"===b.tagName&&(c[b.getAttribute("NAME")]=b.getAttribute("VALUE"));return c},_buildmap:function(a,b){var c=e.format.freemind,d=null;a.parent&&a.parent.isroot&&(d=a.direction===e.direction.left?"left":"right");b.push("<node");b.push('ID="'+a.id+'"');d&&b.push('POSITION="'+d+'"');b.push('TEXT="'+a.topic+'">');b.push('<attribute NAME="expanded" VALUE="'+a.expanded+'"/>');d=a.data;if(null!=d)for(var f in d)b.push('<attribute NAME="'+f+'" VALUE="'+
d[f]+'"/>');f=a.children;for(d=0;d<f.length;d++)c._buildmap(f[d],b);b.push("</node>")}}};e.util={is_node:function(a){return!!a&&a instanceof e.node},ajax:{_xhr:function(){var a=null;if(window.XMLHttpRequest)a=new XMLHttpRequest;else try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(b){}return a},_eurl:function(a){return encodeURIComponent(a)},request:function(a,b,c,d,f){var h=e.util.ajax,q=null,k=[],l;for(l in b)k.push(h._eurl(l)+"="+h._eurl(b[l]));0<k.length&&(q=k.join("&"));var m=h._xhr();m&&(m.onreadystatechange=
function(){if(4==m.readyState)if(200==m.status||0==m.status){if("function"===typeof d){var a=e.util.json.string2json(m.responseText);null!=a?d(a):d(m.responseText)}}else"function"===typeof f?f(m):g.error("xhr request failed.",m)},c=c||"GET",m.open(c,a,!0),m.setRequestHeader("If-Modified-Since","0"),"POST"==c?(m.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),m.send(q)):m.send())},get:function(a,b){return e.util.ajax.request(a,{},"GET",b)},post:function(a,b,c){return e.util.ajax.request(a,
b,"POST",c)}},dom:{add_event:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}},canvas:{bezierto:function(a,b,c,d,f){a.beginPath();a.moveTo(b,c);a.bezierCurveTo(b+2*(d-b)/3,c,b,f,d,f);a.stroke()},lineto:function(a,b,c,d,f){a.beginPath();a.moveTo(b,c);a.lineTo(d,f);a.stroke()},clear:function(a,b,c,d,f){a.clearRect(b,c,d,f)}},file:{read:function(a,b){var c=new FileReader;c.onload=function(){"function"===typeof b&&b(this.result,a.name)};c.readAsText(a)},save:function(a,
b,c){if("function"===typeof p.Blob)a=new Blob([a],{type:b});else{var d=new (p.BlobBuilder||p.MozBlobBuilder||p.WebKitBlobBuilder||p.MSBlobBuilder);d.append(a);a=d.getBlob(b)}navigator.msSaveBlob?navigator.msSaveBlob(a,c):(b=(p.URL||p.webkitURL).createObjectURL(a),a=n.createElement("a"),"download"in a?(a.style.visibility="hidden",a.href=b,a.download=c,n.body.appendChild(a),c=n.createEvent("MouseEvents"),c.initEvent("click",!0,!0),a.dispatchEvent(c),n.body.removeChild(a)):location.href=b)}},json:{json2string:function(a){if(JSON)try{return JSON.stringify(a)}catch(b){return g.warn(b),
g.warn("can not convert to string"),null}},string2json:function(a){if(JSON)try{return JSON.parse(a)}catch(b){return g.warn(b),g.warn("can not parse to json"),null}},merge:function(a,b){for(var c in b)c in a?"object"!==typeof a[c]||"[object object]"!=Object.prototype.toString.call(a[c]).toLowerCase()||a[c].length?a[c]=b[c]:e.util.json.merge(a[c],b[c]):a[c]=b[c];return a}},uuid:{newid:function(){return((new Date).getTime().toString(16)+Math.random().toString(16).substr(2)).substr(2,16)}},text:{is_empty:function(a){return a?
0==a.replace(/\s*/,"").length:!0}}};e.prototype={init:function(){if(!this.inited){this.inited=!0;var a=this.options,b={mode:a.mode,hspace:a.layout.hspace,vspace:a.layout.vspace,pspace:a.layout.pspace},c={container:a.container,support_html:a.support_html,hmargin:a.view.hmargin,vmargin:a.view.vmargin,line_width:a.view.line_width,line_color:a.view.line_color};this.data=new e.data_provider(this);this.layout=new e.layout_provider(this,b);this.view=new e.view_provider(this,c);this.shortcut=new e.shortcut_provider(this,
a.shortcut);this.data.init();this.layout.init();this.view.init();this.shortcut.init();this._event_bind();e.init_plugins(this)}},enable_edit:function(){this.options.editable=!0},disable_edit:function(){this.options.editable=!1},enable_event_handle:function(a){this.options.default_event_handle["enable_"+a+"_handle"]=!0},disable_event_handle:function(a){this.options.default_event_handle["enable_"+a+"_handle"]=!1},get_editable:function(){return this.options.editable},set_theme:function(a){var b=this.options.theme;
this.options.theme=a?a:null;b!=this.options.theme&&(this.view.reset_theme(),this.view.reset_custom_style())},_event_bind:function(){this.view.add_event(this,"mousedown",this.mousedown_handle);this.view.add_event(this,"click",this.click_handle);this.view.add_event(this,"dblclick",this.dblclick_handle)},mousedown_handle:function(a){this.options.default_event_handle.enable_mousedown_handle&&((a=this.view.get_binded_nodeid(a.target||event.srcElement))?this.select_node(a):this.select_clear())},click_handle:function(a){this.options.default_event_handle.enable_click_handle&&
(a=a.target||event.srcElement,this.view.is_expander(a)&&(a=this.view.get_binded_nodeid(a))&&this.toggle_node(a))},dblclick_handle:function(a){this.options.default_event_handle.enable_dblclick_handle&&this.get_editable()&&(a=this.view.get_binded_nodeid(a.target||event.srcElement))&&this.begin_edit(a)},begin_edit:function(a){if(!e.util.is_node(a)){var b=this.get_node(a);if(b)return this.begin_edit(b);g.error("the node[id="+a+"] can not be found.");return!1}this.get_editable()?this.view.edit_node_begin(a):
g.error("fail, this mind map is not editable.")},end_edit:function(){this.view.edit_node_end()},toggle_node:function(a){if(e.util.is_node(a))a.isroot||(this.view.save_location(a),this.layout.toggle_node(a),this.view.relayout(),this.view.restore_location(a));else{var b=this.get_node(a);if(b)return this.toggle_node(b);g.error("the node[id="+a+"] can not be found.")}},expand_node:function(a){if(e.util.is_node(a))a.isroot||(this.view.save_location(a),this.layout.expand_node(a),this.view.relayout(),this.view.restore_location(a));
else{var b=this.get_node(a);if(b)return this.expand_node(b);g.error("the node[id="+a+"] can not be found.")}},collapse_node:function(a){if(e.util.is_node(a))a.isroot||(this.view.save_location(a),this.layout.collapse_node(a),this.view.relayout(),this.view.restore_location(a));else{var b=this.get_node(a);if(b)return this.collapse_node(b);g.error("the node[id="+a+"] can not be found.")}},expand_all:function(){this.layout.expand_all();this.view.relayout()},collapse_all:function(){this.layout.collapse_all();
this.view.relayout()},expand_to_depth:function(a){this.layout.expand_to_depth(a);this.view.relayout()},_reset:function(){this.view.reset();this.layout.reset();this.data.reset()},_show:function(a){(this.mind=this.data.load(a||e.format.node_array.example))?(g.debug("data.load ok"),this.view.load(),g.debug("view.load ok"),this.layout.layout(),g.debug("layout.layout ok"),this.view.show(!0),g.debug("view.show ok"),this.invoke_event_handle(e.event_type.show,{data:[a]})):g.error("data.load error")},show:function(a){this._reset();
this._show(a)},get_meta:function(){return{name:this.mind.name,author:this.mind.author,version:this.mind.version}},get_data:function(a){return this.data.get_data(a||"node_tree")},get_root:function(){return this.mind.root},get_node:function(a){return this.mind.get_node(a)},add_node:function(a,b,c,d){if(this.get_editable()){var f=this.mind.add_node(a,b,c,d);f&&(this.view.add_node(f),this.layout.layout(),this.view.show(!1),this.view.reset_node_custom_style(f),this.expand_node(a),this.invoke_event_handle(e.event_type.edit,
{evt:"add_node",data:[a.id,b,c,d],node:b}));return f}g.error("fail, this mind map is not editable");return null},insert_node_before:function(a,b,c,d){if(this.get_editable()){var f=e.util.is_node(a)?a.id:a;if(a=this.mind.insert_node_before(a,b,c,d))this.view.add_node(a),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(e.event_type.edit,{evt:"insert_node_before",data:[f,b,c,d],node:b});return a}g.error("fail, this mind map is not editable");return null},insert_node_after:function(a,
b,c,d){if(this.get_editable()){var f=e.util.is_node(a)?a.id:a;if(a=this.mind.insert_node_after(a,b,c,d))this.view.add_node(a),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(e.event_type.edit,{evt:"insert_node_after",data:[f,b,c,d],node:b});return a}g.error("fail, this mind map is not editable");return null},remove_node:function(a){if(!e.util.is_node(a)){var b=this.get_node(a);if(b)return this.remove_node(b);g.error("the node[id="+a+"] can not be found.");return!1}if(this.get_editable()){if(a.isroot)return g.error("fail, can not remove root node"),
!1;b=a.id;var c=a.parent.id,d=this.get_node(c);this.view.save_location(d);this.view.remove_node(a);this.mind.remove_node(a);this.layout.layout();this.view.show(!1);this.view.restore_location(d);this.invoke_event_handle(e.event_type.edit,{evt:"remove_node",data:[b],node:c});return!0}g.error("fail, this mind map is not editable");return!1},update_node:function(a,b){if(this.get_editable())if(e.util.text.is_empty(b))g.warn("fail, topic can not be empty");else{var c=this.get_node(a);c&&(c.topic===b?(g.info("nothing changed"),
this.view.update_node(c)):(c.topic=b,this.view.update_node(c),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(e.event_type.edit,{evt:"update_node",data:[a,b],node:a})))}else g.error("fail, this mind map is not editable")},move_node:function(a,b,c,d){if(this.get_editable()){var f=this.mind.move_node(a,b,c,d);f&&(this.view.update_node(f),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(e.event_type.edit,{evt:"move_node",data:[a,b,c,d],node:a}))}else g.error("fail, this mind map is not editable")},
select_node:function(a){if(e.util.is_node(a))this.layout.is_visible(a)&&(this.mind.selected=a,this.view.select_node(a));else{var b=this.get_node(a);if(b)return this.select_node(b);g.error("the node[id="+a+"] can not be found.")}},get_selected_node:function(){return this.mind?this.mind.selected:null},select_clear:function(){this.mind&&(this.mind.selected=null,this.view.select_clear())},is_node_visible:function(a){return this.layout.is_visible(a)},find_node_before:function(a){if(e.util.is_node(a)){if(a.isroot)return null;
var b=null;if(a.parent.isroot)for(var c=a.parent.children,d=null,f,h=0;h<c.length;h++)f=c[h],a.direction===f.direction&&(a.id===f.id&&(b=d),d=f);else b=this.mind.get_node_before(a);return b}if(b=this.get_node(a))return this.find_node_before(b);g.error("the node[id="+a+"] can not be found.")},find_node_after:function(a){if(e.util.is_node(a)){if(a.isroot)return null;var b=null;if(a.parent.isroot)for(var c=a.parent.children,d=!1,f,h=0;h<c.length;h++){if(f=c[h],a.direction===f.direction){if(d){b=f;break}a.id===
f.id&&(d=!0)}}else b=this.mind.get_node_after(a);return b}if(b=this.get_node(a))return this.find_node_after(b);g.error("the node[id="+a+"] can not be found.")},set_node_color:function(a,b,c){if(this.get_editable()){if(a=this.mind.get_node(a))b&&(a.data["background-color"]=b),c&&(a.data["foreground-color"]=c),this.view.reset_node_custom_style(a)}else return g.error("fail, this mind map is not editable"),null},set_node_font_style:function(a,b,c,d){if(this.get_editable()){if(a=this.mind.get_node(a))b&&
(a.data["font-size"]=b),c&&(a.data["font-weight"]=c),d&&(a.data["font-style"]=d),this.view.reset_node_custom_style(a),this.view.update_node(a),this.layout.layout(),this.view.show(!1)}else return g.error("fail, this mind map is not editable"),null},set_node_background_image:function(a,b,c,d,f){if(this.get_editable()){if(a=this.mind.get_node(a))b&&(a.data["background-image"]=b),c&&(a.data.width=c),d&&(a.data.height=d),f&&(a.data["background-rotation"]=f),this.view.reset_node_custom_style(a),this.view.update_node(a),
this.layout.layout(),this.view.show(!1)}else return g.error("fail, this mind map is not editable"),null},set_node_background_rotation:function(a,b){if(this.get_editable()){var c=this.mind.get_node(a);if(c){if(!c.data["background-image"])return g.error("fail, only can change rotation angle of node with background image"),null;c.data["background-rotation"]=b;this.view.reset_node_custom_style(c);this.view.update_node(c);this.layout.layout();this.view.show(!1)}}else return g.error("fail, this mind map is not editable"),
null},resize:function(){this.view.resize()},add_event_listener:function(a){"function"===typeof a&&this.event_handles.push(a)},invoke_event_handle:function(a,b){var c=this;p.setTimeout(function(){c._invoke_event_handle(a,b)},0)},_invoke_event_handle:function(a,b){for(var c=this.event_handles.length,d=0;d<c;d++)this.event_handles[d](a,b)}};e.data_provider=function(a){this.jm=a};e.data_provider.prototype={init:function(){g.debug("data.init")},reset:function(){g.debug("data.reset")},load:function(a){var b=
null;var c="object"===typeof a?a.format?a.format:"node_tree":"freemind";"node_array"==c?b=e.format.node_array.get_mind(a):"node_tree"==c?b=e.format.node_tree.get_mind(a):"freemind"==c?b=e.format.freemind.get_mind(a):g.warn("unsupported format");return b},get_data:function(a){var b=null;"node_array"==a?b=e.format.node_array.get_data(this.jm.mind):"node_tree"==a?b=e.format.node_tree.get_data(this.jm.mind):"freemind"==a?b=e.format.freemind.get_data(this.jm.mind):g.error("unsupported "+a+" format");return b}};
e.layout_provider=function(a,b){this.opts=b;this.jm=a;this.isside="side"==this.opts.mode;this.bounds=null;this.cache_valid=!1};e.layout_provider.prototype={init:function(){g.debug("layout.init")},reset:function(){g.debug("layout.reset");this.bounds={n:0,s:0,w:0,e:0}},layout:function(){g.debug("layout.layout");this.layout_direction();this.layout_offset()},layout_direction:function(){this._layout_direction_root()},_layout_direction_root:function(){var a=this.jm.mind.root;if("layout"in a._data)var b=
a._data.layout;else b={},a._data.layout=b;a=a.children;var c=a.length;b.direction=e.direction.center;b.side_index=0;if(this.isside)for(b=c;b--;)this._layout_direction_side(a[b],e.direction.right,b);else for(b=c;b--;)c=a[b],c.direction==e.direction.left?this._layout_direction_side(c,e.direction.left,b):this._layout_direction_side(c,e.direction.right,b)},_layout_direction_side:function(a,b,c){if("layout"in a._data)var d=a._data.layout;else d={},a._data.layout=d;a=a.children;var f=a.length;d.direction=
b;d.side_index=c;for(c=f;c--;)this._layout_direction_side(a[c],b,c)},layout_offset:function(){var a=this.jm.mind.root,b=a._data.layout;b.offset_x=0;b.offset_y=0;b.outer_height=0;for(var c=a.children,d=c.length,f=[],h=[],g;d--;)g=c[d],g._data.layout.direction==e.direction.right?h.unshift(g):f.unshift(g);b.left_nodes=f;b.right_nodes=h;b.outer_height_left=this._layout_offset_subnodes(f);b.outer_height_right=this._layout_offset_subnodes(h);this.bounds.e=a._data.view.width/2;this.bounds.w=0-this.bounds.e;
this.bounds.n=0;this.bounds.s=Math.max(b.outer_height_left,b.outer_height_right)},_layout_offset_subnodes:function(a){for(var b=0,c=a.length,d=c,f,e,g,k=0,l=null;d--;)f=a[d],g=f._data.layout,null==l&&(l=f.parent._data),e=this._layout_offset_subnodes(f.children),f.expanded||(e=0,this.set_visible(f.children,!1)),e=Math.max(f._data.view.height,e),g.outer_height=e,g.offset_y=k-e/2,g.offset_x=this.opts.hspace*g.direction+l.view.width*(l.layout.direction+g.direction)/2,f.parent.isroot||(g.offset_x+=this.opts.pspace*
g.direction),k=k-e-this.opts.vspace,b+=e;1<c&&(b+=this.opts.vspace*(c-1));d=c;for(c=b/2;d--;)f=a[d],f._data.layout.offset_y+=c;return b},_layout_offset_subnodes_height:function(a){for(var b=0,c=a.length,d=c,f,e,g,k=0,l=null;d--;)f=a[d],g=f._data.layout,null==l&&(l=f.parent._data),e=this._layout_offset_subnodes_height(f.children),f.expanded||(e=0),e=Math.max(f._data.view.height,e),g.outer_height=e,g.offset_y=k-e/2,k=k-e-this.opts.vspace,b+=e;1<c&&(b+=this.opts.vspace*(c-1));d=c;for(c=b/2;d--;)f=a[d],
f._data.layout.offset_y+=c;return b},get_node_offset:function(a){var b=a._data.layout;if("_offset_"in b&&this.cache_valid)var c=b._offset_;else c={x:-1,y:-1},b._offset_=c;if(-1==c.x||-1==c.y){var d=b.offset_x;b=b.offset_y;a.isroot||(a=this.get_node_offset(a.parent),d+=a.x,b+=a.y);c.x=d;c.y=b}return c},get_node_point:function(a){var b=a._data.view,c=this.get_node_offset(a),d={};d.x=c.x+b.width*(a._data.layout.direction-1)/2;d.y=c.y-b.height/2;return d},get_node_point_in:function(a){return this.get_node_offset(a)},
get_node_point_out:function(a){var b=a._data.layout;if("_pout_"in b&&this.cache_valid)var c=b._pout_;else c={x:-1,y:-1},b._pout_=c;if(-1==c.x||-1==c.y)if(a.isroot)c.x=0,c.y=0;else{b=a._data.view;var d=this.get_node_offset(a);c.x=d.x+(b.width+this.opts.pspace)*a._data.layout.direction;c.y=d.y}return c},get_expander_point:function(a){var b=this.get_node_point_out(a),c={};c.x=a._data.layout.direction==e.direction.right?b.x-this.opts.pspace:b.x;c.y=b.y-Math.ceil(this.opts.pspace/2);return c},get_min_size:function(){var a=
this.jm.mind.nodes,b;for(b in a){var c=a[b];c=this.get_node_point_out(c);c.x>this.bounds.e&&(this.bounds.e=c.x);c.x<this.bounds.w&&(this.bounds.w=c.x)}return{w:this.bounds.e-this.bounds.w,h:this.bounds.s-this.bounds.n}},toggle_node:function(a){a.isroot||(a.expanded?this.collapse_node(a):this.expand_node(a))},expand_node:function(a){a.expanded=!0;this.part_layout(a);this.set_visible(a.children,!0)},collapse_node:function(a){a.expanded=!1;this.part_layout(a);this.set_visible(a.children,!1)},expand_all:function(){var a=
this.jm.mind.nodes,b=0,c;for(c in a){var d=a[c];d.expanded||(d.expanded=!0,b++)}0<b&&(a=this.jm.mind.root,this.part_layout(a),this.set_visible(a.children,!0))},collapse_all:function(){var a=this.jm.mind.nodes,b=0,c;for(c in a){var d=a[c];d.expanded&&!d.isroot&&(d.expanded=!1,b++)}0<b&&(a=this.jm.mind.root,this.part_layout(a),this.set_visible(a.children,!0))},expand_to_depth:function(a,b,c){if(!(1>a)){b=b||this.jm.mind.root.children;c=c||1;for(var d=b.length,f;d--;)f=b[d],c<a&&(f.expanded||this.expand_node(f),
this.expand_to_depth(a,f.children,c+1)),c==a&&f.expanded&&this.collapse_node(f)}},part_layout:function(a){var b=this.jm.mind.root;b?(b=b._data.layout,a.isroot?(b.outer_height_right=this._layout_offset_subnodes_height(b.right_nodes),b.outer_height_left=this._layout_offset_subnodes_height(b.left_nodes)):a._data.layout.direction==e.direction.right?b.outer_height_right=this._layout_offset_subnodes_height(b.right_nodes):b.outer_height_left=this._layout_offset_subnodes_height(b.left_nodes),this.bounds.s=
Math.max(b.outer_height_left,b.outer_height_right),this.cache_valid=!1):g.warn("can not found root node")},set_visible:function(a,b){for(var c=a.length,d;c--;)d=a[c],d.expanded?this.set_visible(d.children,b):this.set_visible(d.children,!1),d.isroot||(d._data.layout.visible=b)},is_expand:function(a){return a.expanded},is_visible:function(a){a=a._data.layout;return"visible"in a&&!a.visible?!1:!0}};e.view_provider=function(a,b){this.opts=b;this.jm=a;this.layout=a.layout;this.canvas_ctx=this.e_canvas=
this.e_nodes=this.e_panel=this.container=null;this.size={w:0,h:0};this.editing_node=this.selected_node=null};e.view_provider.prototype={init:function(){g.debug("view.init");if(this.container=u(this.opts.container)?this.opts.container:n.getElementById(this.opts.container)){this.e_panel=n.createElement("div");this.e_canvas=n.createElement("canvas");this.e_nodes=n.createElement("jmnodes");this.e_editor=n.createElement("input");this.e_panel.className="jsmind-inner";this.e_panel.appendChild(this.e_canvas);
this.e_panel.appendChild(this.e_nodes);this.e_editor.className="jsmind-editor";this.e_editor.type="text";this.actualZoom=1;this.zoomStep=.1;this.minZoom=.5;this.maxZoom=2;var a=this;e.util.dom.add_event(this.e_editor,"keydown",function(b){b=b||event;13==b.keyCode&&(a.edit_node_end(),b.stopPropagation())});e.util.dom.add_event(this.e_editor,"blur",function(b){a.edit_node_end()});this.container.appendChild(this.e_panel);this.init_canvas()}else g.error("the options.view.container was not be found in dom")},
add_event:function(a,b,c){e.util.dom.add_event(this.e_nodes,b,function(b){c.call(a,b||event)})},get_binded_nodeid:function(a){if(null==a)return null;var b=a.tagName.toLowerCase();return"jmnodes"==b||"body"==b||"html"==b?null:"jmnode"==b||"jmexpander"==b?a.getAttribute("nodeid"):this.get_binded_nodeid(a.parentElement)},is_expander:function(a){return"jmexpander"==a.tagName.toLowerCase()},reset:function(){g.debug("view.reset");this.selected_node=null;this.clear_lines();this.clear_nodes();this.reset_theme()},
reset_theme:function(){var a=this.jm.options.theme;this.e_nodes.className=a?"theme-"+a:""},reset_custom_style:function(){var a=this.jm.mind.nodes,b;for(b in a)this.reset_node_custom_style(a[b])},load:function(){g.debug("view.load");this.init_nodes()},expand_size:function(){var a=this.layout.get_min_size(),b=a.w+2*this.opts.hmargin;a=a.h+2*this.opts.vmargin;var c=this.e_panel.clientWidth,d=this.e_panel.clientHeight;c<b&&(c=b);d<a&&(d=a);this.size.w=c;this.size.h=d},init_canvas:function(){this.canvas_ctx=
this.e_canvas.getContext("2d")},init_nodes_size:function(a){a=a._data.view;a.width=a.element.clientWidth;a.height=a.element.clientHeight},init_nodes:function(){var a=this.jm.mind.nodes,b=n.createDocumentFragment(),c;for(c in a)this.create_node_element(a[c],b);this.e_nodes.appendChild(b);for(c in a)this.init_nodes_size(a[c])},add_node:function(a){this.create_node_element(a,this.e_nodes);this.init_nodes_size(a)},create_node_element:function(a,b){if("view"in a._data)var c=a._data.view;else c={},a._data.view=
c;var d=n.createElement("jmnode");if(a.isroot)d.className="root";else{var f=n.createElement("jmexpander");t(f,"-");f.setAttribute("nodeid",a.id);f.style.visibility="hidden";b.appendChild(f);c.expander=f}a.topic&&(this.opts.support_html?d.innerHTML=a.topic:t(d,a.topic));d.setAttribute("nodeid",a.id);d.style.visibility="hidden";this._reset_node_custom_style(d,a.data);b.appendChild(d);c.element=d},remove_node:function(a){null!=this.selected_node&&this.selected_node.id==a.id&&(this.selected_node=null);
null!=this.editing_node&&this.editing_node.id==a.id&&(a._data.view.element.removeChild(this.e_editor),this.editing_node=null);for(var b=a.children,c=b.length;c--;)this.remove_node(b[c]);a._data.view&&(b=a._data.view.expander,this.e_nodes.removeChild(a._data.view.element),this.e_nodes.removeChild(b),a._data.view.element=null,a._data.view.expander=null)},update_node:function(a){var b=a._data.view,c=b.element;a.topic&&(this.opts.support_html?c.innerHTML=a.topic:t(c,a.topic));b.width=c.clientWidth;b.height=
c.clientHeight},select_node:function(a){this.selected_node&&(this.selected_node._data.view.element.className=this.selected_node._data.view.element.className.replace(/\s*selected\s*/i,""),this.reset_node_custom_style(this.selected_node));a&&(this.selected_node=a,a._data.view.element.className+=" selected",this.clear_node_custom_style(a))},select_clear:function(){this.select_node(null)},get_editing_node:function(){return this.editing_node},is_editing:function(){return!!this.editing_node},edit_node_begin:function(a){if(a.topic){null!=
this.editing_node&&this.edit_node_end();this.editing_node=a;var b=a._data.view.element;a=a.topic;var c=getComputedStyle(b);this.e_editor.value=a;this.e_editor.style.color="black";this.e_editor.style.width=b.clientWidth-parseInt(c.getPropertyValue("padding-left"))-parseInt(c.getPropertyValue("padding-right"))+"px";b.innerHTML="";b.appendChild(this.e_editor);b.style.zIndex=5;this.e_editor.focus();this.e_editor.select()}else g.warn("don't edit image nodes")},edit_node_end:function(){if(null!=this.editing_node){var a=
this.editing_node;this.editing_node=null;var b=a._data.view.element,c=this.e_editor.value;b.style.zIndex="auto";b.removeChild(this.e_editor);e.util.text.is_empty(c)||a.topic===c?this.opts.support_html?b.innerHTML=a.topic:t(b,a.topic):this.jm.update_node(a.id,c)}},get_view_offset:function(){var a=this.layout.bounds;return{x:(this.size.w-a.e-a.w)/2,y:this.size.h/2}},resize:function(){this.e_canvas.width=1;this.e_canvas.height=1;this.e_nodes.style.width="1px";this.e_nodes.style.height="1px";this.expand_size();
this._show()},_show:function(){this.e_canvas.width=this.size.w;this.e_canvas.height=this.size.h;this.e_nodes.style.width=this.size.w+"px";this.e_nodes.style.height=this.size.h+"px";this.show_nodes();this.show_lines();this.jm.invoke_event_handle(e.event_type.resize,{data:[]})},zoomIn:function(){return this.setZoom(this.actualZoom+this.zoomStep)},zoomOut:function(){return this.setZoom(this.actualZoom-this.zoomStep)},setZoom:function(a){if(a<this.minZoom||a>this.maxZoom)return!1;this.actualZoom=a;for(var b=
0;b<this.e_panel.children.length;b++)this.e_panel.children[b].style.transform="scale("+a+")";this.show(!0);return!0},_center_root:function(){var a=this.e_panel.clientWidth,b=this.e_panel.clientHeight;if(this.size.w>a){var c=this.get_view_offset();this.e_panel.scrollLeft=c.x-a/2}this.size.h>b&&(this.e_panel.scrollTop=(this.size.h-b)/2)},show:function(a){g.debug("view.show");this.expand_size();this._show();a&&this._center_root()},relayout:function(){this.expand_size();this._show()},save_location:function(a){a=
a._data.view;a._saved_location={x:parseInt(a.element.style.left)-this.e_panel.scrollLeft,y:parseInt(a.element.style.top)-this.e_panel.scrollTop}},restore_location:function(a){a=a._data.view;this.e_panel.scrollLeft=parseInt(a.element.style.left)-a._saved_location.x;this.e_panel.scrollTop=parseInt(a.element.style.top)-a._saved_location.y},clear_nodes:function(){var a=this.jm.mind;if(null!=a){a=a.nodes;var b;for(b in a){var c=a[b];c._data.view.element=null;c._data.view.expander=null}this.e_nodes.innerHTML=
""}},show_nodes:function(){var a=this.jm.mind.nodes,b=this.get_view_offset(),c;for(c in a){var d=a[c];var f=d._data.view;var e=f.element;var g=f.expander;if(this.layout.is_visible(d)){this.reset_node_custom_style(d);var k=this.layout.get_node_point(d);f.abs_x=b.x+k.x;f.abs_y=b.y+k.y;e.style.left=b.x+k.x+"px";e.style.top=b.y+k.y+"px";e.style.display="";e.style.visibility="visible";!d.isroot&&0<d.children.length&&(k=d.expanded?"-":"+",e=this.layout.get_expander_point(d),g.style.left=b.x+e.x+"px",g.style.top=
b.y+e.y+"px",g.style.display="",g.style.visibility="visible",t(g,k));d.isroot||0!=d.children.length||(g.style.display="none",g.style.visibility="hidden")}else e.style.display="none",g.style.display="none"}},reset_node_custom_style:function(a){this._reset_node_custom_style(a._data.view.element,a.data)},_reset_node_custom_style:function(a,b){"background-color"in b&&(a.style.backgroundColor=b["background-color"]);"foreground-color"in b&&(a.style.color=b["foreground-color"]);"width"in b&&(a.style.width=
b.width+"px");"height"in b&&(a.style.height=b.height+"px");"font-size"in b&&(a.style.fontSize=b["font-size"]+"px");"font-weight"in b&&(a.style.fontWeight=b["font-weight"]);"font-style"in b&&(a.style.fontStyle=b["font-style"]);if("background-image"in b){var c=b["background-image"];if(c.startsWith("data")&&b.width&&b.height){var d=new Image;d.onload=function(){var b=n.createElement("canvas");b.width=a.clientWidth;b.height=a.clientHeight;b.getContext&&(b.getContext("2d").drawImage(this,2,2,a.clientWidth,
a.clientHeight),b=b.toDataURL(),a.style.backgroundImage="url("+b+")")};d.src=c}else a.style.backgroundImage="url("+c+")";a.style.backgroundSize="99%";"background-rotation"in b&&(a.style.transform="rotate("+b["background-rotation"]+"deg)")}},clear_node_custom_style:function(a){a=a._data.view.element;a.style.backgroundColor="";a.style.color=""},clear_lines:function(a){e.util.canvas.clear(a||this.canvas_ctx,0,0,this.size.w,this.size.h)},show_lines:function(a){this.clear_lines(a);var b=this.jm.mind.nodes,
c=this.get_view_offset(),d;for(d in b){var f=b[d];if(!(f.isroot||"visible"in f._data.layout&&!f._data.layout.visible)){var e=this.layout.get_node_point_in(f);f=this.layout.get_node_point_out(f.parent);this.draw_line(f,e,c,a)}}},draw_line:function(a,b,c,d){d=d||this.canvas_ctx;d.strokeStyle=this.opts.line_color;d.lineWidth=this.opts.line_width;d.lineCap="round";e.util.canvas.bezierto(d,a.x+c.x,a.y+c.y,b.x+c.x,b.y+c.y)}};e.shortcut_provider=function(a,b){this.jm=a;this.opts=b;this.mapping=b.mapping;
this.handles=b.handles;this._mapping={}};e.shortcut_provider.prototype={init:function(){e.util.dom.add_event(n,"keydown",this.handler.bind(this));this.handles.addchild=this.handle_addchild;this.handles.addbrother=this.handle_addbrother;this.handles.editnode=this.handle_editnode;this.handles.delnode=this.handle_delnode;this.handles.toggle=this.handle_toggle;this.handles.up=this.handle_up;this.handles.down=this.handle_down;this.handles.left=this.handle_left;this.handles.right=this.handle_right;for(var a in this.mapping)this.mapping[a]&&
a in this.handles&&(this._mapping[this.mapping[a]]=this.handles[a])},enable_shortcut:function(){this.opts.enable=!0},disable_shortcut:function(){this.opts.enable=!1},handler:function(a){if(!this.jm.view.is_editing()){if(!this.opts.enable)return!0;var b=(a||event).keyCode;b in this._mapping&&this._mapping[b].call(this,this.jm,a)}},handle_addchild:function(a,b){var c=a.get_selected_node();if(c){var d=e.util.uuid.newid();a.add_node(c,d,"New Node")&&(a.select_node(d),a.begin_edit(d))}},handle_addbrother:function(a,
b){var c=a.get_selected_node();if(c&&!c.isroot){var d=e.util.uuid.newid();a.insert_node_after(c,d,"New Node")&&(a.select_node(d),a.begin_edit(d))}},handle_editnode:function(a,b){var c=a.get_selected_node();c&&a.begin_edit(c)},handle_delnode:function(a,b){var c=a.get_selected_node();c&&!c.isroot&&(a.select_node(c.parent),a.remove_node(c))},handle_toggle:function(a,b){var c=b||event,d=a.get_selected_node();d&&(a.toggle_node(d.id),c.stopPropagation(),c.preventDefault())},handle_up:function(a,b){var c=
b||event,d=a.get_selected_node();if(d){var f=a.find_node_before(d);f||(d=a.find_node_before(d.parent))&&0<d.children.length&&(f=d.children[d.children.length-1]);f&&a.select_node(f);c.stopPropagation();c.preventDefault()}},handle_down:function(a,b){var c=b||event,d=a.get_selected_node();if(d){var f=a.find_node_after(d);f||(d=a.find_node_after(d.parent))&&0<d.children.length&&(f=d.children[0]);f&&a.select_node(f);c.stopPropagation();c.preventDefault()}},handle_left:function(a,b){this._handle_direction(a,
b,e.direction.left)},handle_right:function(a,b){this._handle_direction(a,b,e.direction.right)},_handle_direction:function(a,b,c){b=b||event;var d=a.get_selected_node();var f=null;if(d){if(d.isroot){f=d.children;d=[];for(var e=0;e<f.length;e++)f[e].direction===c&&d.push(e);f=f[d[Math.floor((d.length-1)/2)]]}else d.direction===c?(d=d.children,c=d.length,0<c&&(f=d[Math.floor((c-1)/2)])):f=d.parent;f&&a.select_node(f);b.stopPropagation();b.preventDefault()}}};e.plugin=function(a,b){this.name=a;this.init=
b};e.plugins=[];e.register_plugin=function(a){a instanceof e.plugin&&e.plugins.push(a)};e.init_plugins=function(a){p.setTimeout(function(){e._init_plugins(a)},0)};e._init_plugins=function(a){for(var b=e.plugins.length,c,d=0;d<b;d++)c=e.plugins[d].init,"function"===typeof c&&c(a)};e.show=function(a,b){var c=new e(a);c.show(b);return c};p.jsMind=e}})(window);